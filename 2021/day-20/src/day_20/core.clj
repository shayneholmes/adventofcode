(ns day-20.core)
; demo
(def algorithm "..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#")

(def input ["#..#."
            "#...."
            "##..#"
            "..#.."
            "..###"])


; real data

(def algorithm "##.#.###.....###.#...###.#.##..#....##.#.######.......#.....###....###.##..#..####.##....#....#####.###.##....#.###.#...#..###.###....#..#..##..#.###..#..#..#...##..##...##.###..#.####..#.####..#...#.###..#.###..#...###..##.#...####..#.##.#....###...####.###.#..#.#.....##.#..#...#.####.##..#.##...##.#..#...###......###...##..#..####.....#.###.#.###..#...#.##....#...#.######....###.#.....###.##.#.#..#....##..#..#....###..####....#.#.##.#.##.#.#.#..#..##.#...####..###.##.####..#..#.#.##.#..#.#...#.#....#...#.")

(count algorithm)

(def input ["#.##.##..#.#.#..#####.##..#.#.#.##...#####.##...##.#####.##...#....#..#...#.##.#....##.#.#.....#.#.."
            "######..#.####...#.########.###..#..#....#..######.#.###...#......#.#....##..#..#.###.#..#####..#..#"
            "##.#..#....#####.....##..##.##.#..###.....##.#####....#..####.######...#...###.##..#####.#..#....#.."
            "####.#####...#....##.#.##..#####..####.#...#..#..####.##..#..##........##.#..#...#.######...#.#..#.#"
            "###.#.#........##.....#.#.###.###...#..####...#..##..#....###########.####.#.......#.#..#.#..#####.."
            "#.#....#..##.#..##..#...##.#.####.#..#....##.##....####.#..##.##.##.#.#.##.###.##....#..###.##...#.#"
            "##.####.#.....###..#....#.##..###..####.###.####.#.####....###..##.#...#####.####..##..#######.#.#.."
            "#..##..####.#.##..##.#..#..#.#...##.#.#..##.#.#.######.##.#...###.###.......#..##...##..#.##....#..."
            "###.##.#..##.##...###.###.#..###.#.....##..##..###...#...##..##..#..######..#.#...#.#....#..#.###..."
            ".##..##.#.#..###.###.#....##....#.##..#..##...###..#.##.....#####..#.#..#####..########...#...#.#.#."
            "#####..##.####.##.#.##...#.##.#.###.####.######....#.#.##.#.##.#....##.####...####........###...#..."
            ".#####.#...#.####.###..#...#..####...#..#..#...####....#...#####.#.#.#.#.#..#..#....#.#.#####..##.#."
            "##..#.....###.######.##..#..##.##.###.###...######...##.#..##.#.#.#..#.##..###..#..##..#.####...##.#"
            "#...#.#..#.###..#..#####.###.#.#.#.#.##.#####....##...##.....#.###.##.#######..##.##..#.#.#..#....#."
            "###..##.#.#.##.###.....#.#.###...##.###..#..#######...##...#.#.##.###.#.##.####.#......##...###...#."
            "#....#..####.##...#.#...###.#.###.###...##....##.#.##.##..###..#.#.#.#...#.#.#....#.###.###.#...#.##"
            "..#.##.####..####..##.#..#..#.#######.#.##.#.###...##.#...#######..#.##.#..#.#........###.#..###.#.."
            "....#..#.####.##...#.###.#..#....#.#.###.#.....#...###.###.#..##..####.#.#...###.#.#....#..#.##..###"
            "#...#..#.#.##.#....###.##..........#.#..........#.####..#.#.###..#.##..##...########.###.##.##.#..##"
            "##.####...#..###.#..#.##..#....##.#.....###...###....#.##.##...##..#.####.##....##....#.#.......##.#"
            "..##..#.#...#..##....##.##.##.#..#.#.##...######...##..#...###.#.#########..###.#.#.##.#.#####......"
            "##....###.#.#.#.#.....#.#.....##...#...#...####...###.#####.##....##.#..###.......##.....##...#.##.."
            "##.#.......##.######.#...##....###..###.....#.....##...#.......###.#..##.##..#.#..###.#.#.#...#.##.."
            ".....#.#.##....#####..#..#..#..#..##.##.#.#...#...##.#.#...#...###.#...#.##.##.....#..#.###.....#..."
            "#.#.#..######.#.#.##..##.##.#.#..###.#...#.##.###..#.#.###.###..###.....#.##.#....#.####.#...###.#.."
            ".###..#.#.#..####...###..#.##.#..#####...#####..#.#..#..####.###.##...##.##..##.#...#.#...#.#.######"
            "#.##.#..##..###..####..#.##.######..####...#..##.##.###...##.##...###....#..#..##.#...###..##.#..###"
            "...###....######....##.##.###.####.######.#..#.####.##########...#..##.##.##.#.....####.####..###.##"
            "...#..##.##.......#.##.#.##...###.#.##.###.#....#..###.###.###..###.#.....##...#.#########.#..####.#"
            "##...#..#......####.#..#.##.##.#...###.###...#..#####..#.#.....##.#....##.#.##.##.#####....#.###...."
            "##.###.#..#....#############...##.#####.#..#####..#####.#......#.##.#.###.#.##.#.##.#.#.#....#....#."
            ".####.....#..##.####.#.#..#.###..#####..##..#.#..###...###.##..#...#..#.#..##...#.##.##.###..###.#.#"
            "#.#...##.#.##.#..##.#...#####..#....#.#...###.####.##.##.#..#.##..####.##.##.#.#.###..###.#........."
            ".###.#....#..#..#..#..###.###.##.#.####...#.#...###....####.##.#.###.###..#.#.#..#.#..#.#......###.."
            ".##.###..#.#.#..##.##..##..#......#####..####.#..#..#.##.##...#.#..##.#..#..##..####.#####.#..#..##."
            "..###.##.#####..#####.##.#.#...#.#....#....#.##.###....####....#..#......###....###.#.....#..#######"
            "###...#.#.#...#.####.#..###.....###.##..#####.#.#.....#...#.#..#..##...##..#.##.##.#.#.#..###.####.."
            "####....#...##...###.##.####....##.###.#...###...#.###..#...#...#######..#..#.#.###..####.######.##."
            "....#.###.#....#...#.##.######.####.###.#.#.#.#.##....##..#.###..#####.#..#..###..#..#.####..###.#.#"
            "#.#####.##.######........######...####.......####...###...#....#.#..####.##..##......####..#..#..#.."
            "##########...##.###.##.##.#.###.#.#.#.#...##.#.##.####.....###.###..##.#.####..#...#.......#.#######"
            ".#....#...#....#..#.#..##...#....#.##..#...##......#.##.##.##.####.#..###...#####.......#..##..####."
            ".###.#.#.#..##.#...#...#..##..########.####.##.###..#.#.#..#.#####..#.###..#..#....#.##.#..####.#.##"
            "######.##...##..#..######..#.#.###....#......###...#####.##.#.##..#.#.#.##..##....####.###.....##..."
            ".###....#.###.#..###.#.##..#...#...#.#..#..####.###....##.#######.#....######.#...########.####.#..#"
            ".##..#.###...##.#.#.#..#.##..#....###..#.#.##.#...#.#...#.##.#..###....#..##.#..#..##.###...#######."
            "##....#.....#...#..###..###.##.###..#...###.##.##.#.####.#.####...#.###..##...#.#.##.#.###.###..#..#"
            "###.##...##..#..#....####.##.#...##.#...#.....###.#....#####...#.##...#....#.#..#.....##.###..##.#.."
            "####...#..#.#.##.##.##.#...######.....####.###.####.#..##..#.##...###....#...#.#.#.###..##....##.###"
            "#.###.#.#..####.#..#.##...#.#.......#..###.#######.#...##.##...#..##.....###.#...#..#.#...#.#..##.##"
            "##.####..#..#.##.##.#######.#..##....#.##..#...##.#.###...#..#.......#....#####..#.#.#..#..#..##.#.#"
            "#..#.##..#.#....##....###.#....##..##.###...##.#####.#..#...###.##..##.........#..#.#.###.#..#####.."
            "...#..##.#..##.##.#.###..#.#..#.#.#.#..........#......##.##.#...#.#####..#.#.##.#.####...#.#..##...#"
            ".###..##....##.###..#..###.#...#..###..#...#..#.##.##.##.#...#.#.##...#.#.####.....#.###..##..######"
            "##....##.######.###...#.##...#..##.####.#...#..##....########.#..#####..#.#.#...###...#.##...#.##..."
            ".#.#....#.#...#...#.#...#..#.#.#.#..#..##.##..####....#.##.##..########.#.......##..##....####.....#"
            "#####.#.#.####.###########.#..##.#.#...#..##......###..#.##..####.#####.#.#..##....#...#####.###..##"
            "##...#...#..####.###..#..#.#.####.#...##..###########.#..##.##.###...#.#####.##.#.#..#####..#...###."
            ".#...###...#.###...####.#.#.##...#.#.####....#.######...#....#.###.....##..##..#.##.##.#.##.#.#....."
            "..###.#.######.#..#####.#...##.#.#####.###.#..##.#...#.#...#...#####...#....#..##.###..#.......##.##"
            "..#.#..#.######..#..##....##.#.#..#####.####.....##...#.....###.##.#...#.#....#.#..##...#.#.#...##.#"
            "#.##..######..#.#..##....##..###........#.#....#.#.#..#..###...#.........##.###.##.##.....#...#.##.."
            "....###.#.#.###.#..##.#.##.#.##...##.#...#..#..####..#.##.#..#..###..############..#..#..###.###.#.#"
            "#####.####...#.#.#.###.##.##.##.########.####..#..####...#....#.#......#.##..###....##..#.#........#"
            ".#.#.##.#.##########...#######.###.###..####..#...#..###.##.##...######...#.##...##...##...#######.#"
            "#####.#.#.##.....##.#..##...#..#.#.##.###.#..#..###.#..##.......##...#.##.###..#...#.#..##..#..#...#"
            "##.##.#.####.#...####.#.##.####...###.##.#.....#.#######.#.##...####..#.#.#...####.....#.#.###..#..#"
            "......#.####...#.#....#####....#.####....#....#..#..#.##..#.#..##...####.#.###.#...#..##..##.####.#."
            "#.#.#....#..#.#...##.##...####...#..#####.#.....#...###........###.#.#..#....#.#..#.##.....##....###"
            "...##.#.#...#.#....####..##.###..####.##.##.#.......##...#..#....#.....#..#.#....##.#....####.#..#.#"
            "##..#..#.##.#.###.#..####...#####......###.#.#.#..#...#.#.....#.###...#######.#.##.#..##.#.#..#.###."
            "##..#.....##.#.###.##.#.#.##..#..##...#..###.#.#..####...####.#.#....#...#...###.#.#.####...####..##"
            "#..###.##.##.#.#..###.###.###..###.#.####.#..#....###..####.........#..##.....##..##..###...##.#...."
            ".#.#.##.##..#..#.#..#......#..###.##...#..#..####..##.####.#..........####.#.#.##....#..#.#....#.##."
            "...##.#...#.....#.#######.#...##.#...##.###.#..###.....###.#.#.#.#....##..#.##.#..#.##...#..#..#.#.."
            "..#..#...##.#.#.##..##....###.###..###...###....####..#.....##..##.###.#####......###.#.#..##.##.##."
            "...#####.###..#.##.##.##...#.###.....##.#.###....##.#.#.#########..#.##.##...##.###...#.#.#...#.#..."
            "....#.#..#.#.#.##.....#.#.#.#.###.##..###........#.###.###.###......#.####.##...#.#####.#.#.#....###"
            "#...#.#.#.#.##..##..#....#..#...#.#..#..#....##.####..#######.#...#..#...##.#..#.###.#.#.##.###..##."
            "#####.#..#.#####.#.##..##.......#.#.######.#.##.#.##.#.#####..#..#.#..#...#.#..###.##...##.########."
            ".#.#.#.#..##..#.###.#....##...#.####.###.#.###..#.##.#..#.###.#..#..#.#.#..#..#.....#..###.#.#...#.#"
            "##..#.##..#...#.##.##.#..#......#.#.....####...#.#.#.#.#.##....#...##..#.##.####..#...#....#...####."
            "...#.##....##..##...##.####..###...####.....#.#.#.#....###....#.###..#..#..##.####....##.##.....###."
            "#....##.......##.#####...###.#.#.##....##..#....#.#.#..#.#.#..#######.##...#.#.#.#.#.#.#.###......##"
            "#.....#....#..##..#..###.#.##.##..###..#.##.#....#..###.#.#...#.######...##.#..#....#..#..#.#......."
            ".#.###.#.#...#.####..####...#.#.#....#..##..#####.#.##....####..#.###.#.####...######.#..#....###..#"
            ".#.##..#...#.#..##.#..#..####..#.#..#...##.#.#.####.#..###.##.....########.####..##.##.##.##..#.#..#"
            "..###..#.####.##.#..#######.##..#..#.#.#...#.####...#....##..#.##.##.#...#..##...###....#.....#..#.."
            "#....##...#...#.#.#.###.##.###....#...#.###.#...##...###..#.#.###.#.##...##...#..#.#.#.#.#.####...##"
            "###.##.#.#.###...####.#....###.###.######.######.#.##.####.##..###...##.##.#.....#.##.#..#.#####...#"
            "#.#########.#.#.#.#...##.####..#.#.#####.#.###...##.#....##..#####...###.#..###..#..#.##.##.#.##.#.."
            ".#......###...##.....#..#.####.##..#####..#..#.##...####.##..#....#.#.#.###.#...##.##....###..##..##"
            "#...#.....##..###..#####.#.#.##...##.##.####..##.###.#.#.###.#...#.......###.####.##.#####.#..##...#"
            "#...###.######.###..#...##...##.#....#.#.....####....#.#..#........###.#.....##...#.##...#.###..###."
            ".#..#.###....#.####.....##...#.#.#####..###..#.##.#.#.#..#....#.##..#.#..##..#.####...###..##.#....."
            "###.##.##.##.#.#..#..#.#.#.####.####.#.....##.#.#.....###.####..#.....#......######.#.##.#.#..#....#"
            "..#####.#.##...#.##.#..#..####.....##..#.#.##..#..##...#..###...#.......#.##....#.##.#..#######.##.."
            "##.#...##...#.##....####.##.#.#..#.####..#..#####...#.###.....#.#....#.######.##......####..#.##.#.."
            "#.#.#.###....##..#.##..##.....#..#.#.###.#.#.#....#....#.####...##...#.##.######.#....##.##..###..##"
            "#..#.#...###.#..#...######...#.###...#.....###...##..####.#.#.#####.#####..#..#.#..####.##.##...###."])

(range -1 5)

(defn is-light [ch] (or (= ch true) (= ch \#)))

(defn get-accessor [input]
  (fn [y x]
    (let
     [inf-value (get (get input 0) 0) ; use 0,0 as a proxy for infinite padding. Better make sure the padding is big enough!
      ch
      (if
       (or
        (< y 0)
        (>= y (count input)))
        inf-value
        (let
         [row (get input y)]
          (if
           (or
            (< x 0)
            (>= x (count row)))
            inf-value
            (get row x))))]
      (is-light ch))))

((get-accessor input) 1 2)

(range -1 2)

(map + (range -1 2))

; return a 3x3 window of booleans centered on the given coordinates
(defn
  get-window
  [accessor y x]
  (for [i (range -1 2)]
    (for [j (range -1 2)]
      (accessor (+ y i) (+ x j)))))

(get-window (get-accessor input) 2 2)

(defn get-enhanced-value
  [accessor y x]
  (let [input (get-window accessor y x)
        flatter (flatten input)
        bitvalue (fn [i v] (if v (bit-shift-left 1 (- 8 i)) 0))
        bitwise (apply + (map-indexed bitvalue flatter))
        answer (is-light (get algorithm bitwise))]
    answer))

(get-enhanced-value (get-accessor input) 2 2)

(- 5)

(defn pad [padding input]
  (let [accessor (get-accessor input)
        height (count input)
        width (count (get input 0))]
    (vec
     (for [i (range (- padding) (+ padding (count input)))]
       (let [row (if (and (>= i 0) (< i height)) (get input i) nil)]
         (vec
          (for [j (range (- padding) (+ padding width))]
            (let [el (if (and
                          (not (empty? row))
                          (>= j 0)
                          (< j height))
                       (accessor i j)
                       false)]
              el))))))))

(pad 5 [[true]])

(defn enhance [input]
  (vec
   (for [i (range  0 (count input))]
     (vec
      (for [j (range  0 (count (get input 0)))]
        (get-enhanced-value (get-accessor input) i j))))))

(let [padded (pad 76 input)
      enhanced (enhance-times 50 padded)
      flattened (flatten enhanced)
      filtered (filter true? flattened)]
  (count filtered))

(println "a ")

(defn enhance-times [times input]
  (if (= 0 times)
    input
    (recur (dec times) (enhance input))))

(defn print-image [input]
  (let [row-array
        (for [i (range 0 (count input))]
          (let [row (get input i)
                row-symbols
                (for [j (range 0 (count row))]
                  (let [el (get row j)]
                    (if (is-light el) "#" ".")))
                row-str (println (clojure.string/join row-symbols))]
            row-str))
        all-together (clojure.string/join "\n" row-array)]))

(let [padded (pad 15 input)
      enhanced (enhance-times 1 padded)]
  (print-image enhanced))


(get-window (get-accessor (enhance-times 1 (pad 5 [[true]]))) 10 10)

(print-image (enhance-times 50 (pad 25 [[true]])))
